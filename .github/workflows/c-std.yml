name: C Standard

# Set to manual execution only for now.
on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  configure:
    name: ${{ matrix.compiler }} + ${{ matrix.builder }} -std=${{ matrix.std }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest

        compiler:
          - gcc
          - clang

        builder:
          - configure
          - cmake

        include:
          - std: c89
            cmd: c89

          - std: gnu89
            cmd: gnu89

          - std: c94
            cmd: iso9899:199409

          - std: c99
            cmd: c99

          - std: gnu99
            cmd: gnu99

          - std: c11
            cmd: c11

          - std: gnu11
            cmd: gnu11

          - std: c17
            cmd: c17

          - std: gnu17
            cmd: gnu17

          - std: c2x
            cmd: c2x

          - std: gnu2x
            cmd: gnu2x


    steps:

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        show-progress: 'false'

    - name: Install packages (Ubuntu)
      run: |
        sudo apt-get update

    - name: Generate project files (configure)
      if: matrix.builder == 'configure'
      run: |
        ./configure
      env:
        CC: ${{ matrix.compiler }}
        CFLAGS: -std=${{ matrix.cmd }} -Werror

    - name: Compile source code (configure)
      if: matrix.builder == 'configure'
      run: make -j2

    - name: Run test cases (configure)
      if: matrix.builder == 'configure'
      run: |
        make test
        make cover

    - name: Generate project files (cmake)
      if: matrix.builder == 'cmake'
      run: |
        cmake -S . -B . -D CMAKE_BUILD_TYPE=Release -D ZLIB_BUILD_EXAMPLES=OFF
      env:
        CC: ${{ matrix.compiler }}
        CFLAGS: -std=${{ matrix.cmd }} -Werror

    - name: Compile source code (cmake)
      if: matrix.builder == 'cmake'
      run: cmake --build . --config Release

    - name: Run test cases (cmake)
      if: matrix.builder == 'cmake'
      run: ctest -C Release --output-on-failure --max-width 120

    - name: Upload build errors (configure)
      uses: actions/upload-artifact@v4
      if: failure() && matrix.builder == 'configure'
      with:
        name: ${{ matrix.compiler }} ${{ matrix.std }} (configure)
        path: |
          ./configure.log
        if-no-files-found: ignore
        retention-days: 7

    - name: Upload build errors (cmake)
      uses: actions/upload-artifact@v4
      if: failure() && matrix.builder == 'cmake'
      with:
        name: ${{ matrix.compiler }} ${{ matrix.std }} (cmake)
        path: |
          **/CMakeFiles/CMakeOutput.log
          **/CMakeFiles/CMakeError.log
        if-no-files-found: ignore
        retention-days: 7
